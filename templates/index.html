<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Consola Web</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="container">
        <div class="console">
            <div class="history" id="history">
                {% for line in output.split('\n') %}
                    <pre class="history-line">{{ line }}</pre>
                {% endfor %}
            </div>
            <div class="input-area">
                <input type="text" id="command" placeholder="Escribe un comando..." autocomplete="off">
                <button id="execute">Ejecutar</button>
            </div>
        </div>
        
        <div class="files-panel">
            <div class="upload-section">
                <input type="file" id="fileInput" hidden accept=".py">
                <button onclick="document.getElementById('fileInput').click()" class="btn-upload">
                    Subir Script
                </button>
            </div>
            
            <div class="file-list">
                <h3>Archivos Disponibles:</h3>
                {% for file in files %}
                    <div class="file-item">
                        <span>{{ file }}</span>
                        <div class="file-actions">
                            <button onclick="runFile('{{ file }}')" class="btn-run">Ejecutar</button>
                            <button onclick="deleteFile('{{ file }}')" class="btn-delete">Borrar</button>
                        </div>
                    </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const historyDiv = document.getElementById('history');
        const commandInput = document.getElementById('command');
        const executeBtn = document.getElementById('execute');
        
        function appendToHistory(content) {
            const pre = document.createElement('pre');
            pre.className = 'history-line';
            pre.textContent = content;
            historyDiv.appendChild(pre);
            historyDiv.scrollTop = historyDiv.scrollHeight;
        }

        async function executeCommand() {
            const command = commandInput.value.trim();
            if (!command) return;
            
            try {
                const response = await fetch('/execute', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({command: command, mode: 'bash'})
                });
                
                const data = await response.json();
                if (data.error) throw new Error(data.error);
                
                data.history.forEach(line => appendToHistory(line));
                commandInput.value = '';
            } catch (error) {
                appendToHistory(`Error: ${error.message}`);
            }
        }

        async function uploadFile(file) {
            const formData = new FormData();
            formData.append('archivo', file);
            
            try {
                const response = await fetch('/upload', {
                    method: 'POST',
                    body: formData
                });
                const result = await response.json();
                if (result.error) throw new Error(result.error);
                window.location.reload();
            } catch (error) {
                appendToHistory(`Upload Error: ${error.message}`);
            }
        }

        document.getElementById('fileInput').addEventListener('change', (e) => {
            if (e.target.files[0]) uploadFile(e.target.files[0]);
        });

        executeBtn.addEventListener('click', executeCommand);
        commandInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') executeCommand();
        });

        window.runFile = async (filename) => {
            try {
                const response = await fetch(`/run/${filename}`);
                const data = await response.json();
                if (data.error) throw new Error(data.error);
                appendToHistory(`$ python ${filename}\n${data.output}`);
            } catch (error) {
                appendToHistory(`Execution Error: ${error.message}`);
            }
        };

        window.deleteFile = async (filename) => {
            if (!confirm(`Â¿Borrar ${filename}?`)) return;
            try {
                const response = await fetch(`/delete/${filename}`);
                const data = await response.json();
                if (data.error) throw new Error(data.error);
                window.location.reload();
            } catch (error) {
                appendToHistory(`Delete Error: ${error.message}`);
            }
        };
    });
    </script>
</body>
</html>